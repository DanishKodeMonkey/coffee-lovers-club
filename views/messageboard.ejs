<!DOCTYPE html>
<html>
    <%- include('./partials/head.ejs') %>
    <body>
        <%- include('./partials/header.ejs') %>
        <main class="container mt-5">
            <div class="messages">
                <h1 class="display-4 mb-4">
                    <%= title %> <% if (isAnon) { %> (read only mode)
                </h1>

                <div>
                    <p>Welcome to anonymous read-only mode!</p>
                    <p>How about joining in?</p>
                    <div class="d-flex mt-3 mb-5">
                        <div class="m-1">
                            <a
                                class="btn btn-primary"
                                href="/auth/sign-in"
                                >Already a user? Sign in!</a
                            >
                        </div>
                        <div class="m-1">
                            <a
                                class="btn btn-primary"
                                href="/auth/sign-up"
                                >New user? Sign up today!</a
                            >
                        </div>
                        <% } %>
                    </div>
                </div>
                <hr />
                <% if (!isAnon && userMembership !== 'Guest') { %>
                <button
                    class="btn btn-primary"
                    onclick="openModal()"
                >
                    Create new message
                </button>
                <dialog
                    id="messageModal"
                    class="modal"
                >
                    <div class="modal-content">
                        <span
                            class="close"
                            onclick="closeModal()"
                            >&times;</span
                        >
                        <form
                            action="messages/create"
                            method="post"
                        >
                            <input
                                type="hidden"
                                name="author"
                                value="<%= userId %>"
                            />
                            <label for="title">Title</label>
                            <input
                                type="text"
                                name="title"
                                required
                                maxlength="50"
                            />
                            <label for="message">Message</label>
                            <textarea
                                name="message"
                                id=""
                                cols="30"
                                rows="10"
                                maxlength="600"
                            ></textarea>
                            <button type="submit">Submit</button>
                        </form>
                        <div
                            id="errorContainer"
                            style="display: none"
                        >
                            <p>Errors:</p>
                            <ul id="errorList"></ul>
                        </div>
                    </div>
                </dialog>
                <% } %> <% if (!messages.length ) { %>
                <p>No messages found</p>
                <% } else { %>
                <ul>
                    <% messages.forEach(message => { %>
                    <li>
                        <h2><%= message.title %></h2>
                        <% if (!isAnon) { %>
                        <hr />
                        <h3><%= message.author.username %></h3>
                        <% } %>
                        <h4>
                            <%= message.timestamp.toLocaleString('en-GB', {day:
                            'numeric', month: 'short', year:'numeric', hour:
                            '2-digit', minute: '2-digit', second:'2-digit'}) %>
                        </h4>
                        <hr />
                        <p><%= message.message %></p>
                        <% if (!isAnon) { %>
                        <!-- Display a delete button only to the author or an admin user -->
                        <% if (userId.equals(message.author._id) ||
                        userMembership === 'Admin') { %>
                        <form
                            action="messages/<%= message._id %>/delete"
                            method="post"
                            onsubmit="return confirm('Are you sure you want to delete this message?');"
                        >
                            <button type="submit">Delete</button>
                        </form>
                        <% } %> <% } %>
                    </li>
                    <% }) %>
                </ul>
                <% } %>
            </div>
        </main>
        <%- include('./partials/footer.ejs') %>
    </body>
</html>
